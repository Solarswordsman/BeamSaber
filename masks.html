<div class="container"><input class="type" type="hidden" name="attr_sheet_type" value="hero"/><!-- Title & Version--><div class="topholder flex"><!-- Toggle the type of sheet--><div class="type-selector label"><input class="hidden sheet-3waybox" type="checkbox" name="attr_sheet_type" value="story"/><input class="sheet-3waybox" type="radio" name="attr_sheet_type" value="hero" checked="checked"/><input class="sheet-3waybox" type="radio" name="attr_sheet_type" value="villain"/><input class="sheet-3waybox" type="radio" name="attr_sheet_type" value="story"/><span data-i18n="hero_mode"></span><span data-i18n="villain_mode"></span><span data-i18n="story_mode"></span></div><label class="settings-checkbox"><input type="checkbox" name="attr_show_settings" value="1"/><span>y</span></label><div class="version"><span class="version-text" data-i18n="version"></span><span name="attr_version"></span></div></div><input class="hider" type="hidden" name="attr_show_settings" value="0"/><!-- Settings--><div class="settings flex-wrap"><div class="setting-char generaterow"><select name="attr_generate_source_character" title="Choose source"><option value="beacon" data-i18n="beacon"></option></select><label class="generatebutton"><input type="checkbox" name="attr_generate_ability" value="1"/><span data-i18n="add_abilities"></span></label><label class="generatebutton"><input type="checkbox" name="attr_generate_friend" value="1"/><span data-i18n="add_friends"></span></label><label class="generatebutton"><input type="checkbox" name="attr_generate_playbookitem" value="1"/><span data-i18n="add_items"></span></label><label class="generatebutton"><input type="checkbox" name="attr_generate_crewability" value="1"/><span data-i18n="add_abilities"></span></label><label class="generatebutton"><input type="checkbox" name="attr_generate_contact" value="1"/><span data-i18n="add_contacts"></span></label><label class="generatebutton"><input type="checkbox" name="attr_generate_upgrade" value="1"/><span data-i18n="add_upgrades"></span></label></div><div class="setting-char setting-crew setting-faction"><label><input class="checkbox squarebox" type="checkbox" name="attr_setting_flexwidth" value="1"/><span></span><span data-i18n="flexible_width"></span></label></div><div class="setting-char setting-crew setting-faction"><label><input class="checkbox squarebox" type="checkbox" name="attr_setting_focus_shadow" value="1" checked="checked"/><span></span><span data-i18n="show_outline"></span></label></div><div class="setting-char setting-crew setting-faction"><label><input class="checkbox squarebox" type="checkbox" name="attr_setting_show_broadcast" value="1" checked="checked"/><span></span><span data-i18n="show_broadcast"></span></label></div><div class="setting-char setting-crew"><label><input class="checkbox squarebox" type="checkbox" name="attr_setting_autofill" value="1" checked="checked"/><span></span><span data-i18n="fill_fields"></span></label></div><div class="setting-char setting-crew"><input class="wide" type="text" spellcheck="false" name="attr_chat_image" value=""/><span data-i18n="chat_image"></span></div><div class="setting-char setting-crew setting-faction kirsty-option"><label><input class="checkbox squarebox" type="checkbox" name="attr_setting_usekirsty" value="1"/><span></span><span data-i18n="use_kirsty"></span></label></div></div></div>
<script type="text/worker">"use strict";const data={playbook:{beacon:{base:{danger:-1,freak:-1,savior:2,superior:0,mundane:2}}},actions:{},moves:[],translatedDefaults:{bull_lover:"lover",bull_rival:"rival"},defaultValues:{attune:"0",command:"0",consort:"0",finesse:"0",hunt:"0",prowl:"0",skirmish:"0",study:"0",survey:"0",sway:"0",tinker:"0",wreck:"0"}},sheetVersion="1.0",sheetName="Masks - A New Generation",getTranslation=a=>getTranslationByKey(a)||"NO_TRANSLATION_FOUND";/* global data, getTranslationByKey, getAttrs, setAttrs, on, getSectionIDs, generateRowID, removeRepeatingRow *//* It's necessary to include the base data at the start of the file *//* Translate all the data */data.items.forEach(a=>{a.boxes_chosen="1",a.name=getTranslation(a.name),a.description=getTranslationByKey(a.description)||""}),Object.keys(data.translatedDefaults).forEach(a=>{data.translatedDefaults[a]=getTranslation(data.translatedDefaults[a])}),Object.assign(data.defaultValues,data.translatedDefaults),Object.keys(data.factions).forEach(a=>{data.factions[a].forEach(a=>{a.name=getTranslation(a.name)})}),Object.keys(data.playbook).forEach(a=>{const b=data.playbook[a].base;Object.keys(b).forEach(a=>{data.translatedPlaybookAttributes.includes(a)&&(b[a]=getTranslation(b[a]))}),data.playbook[a].ability=data.playbook[a].ability.map(a=>({name:getTranslation(`playbook_ability_${a}`),description:getTranslation(`playbook_ability_${a}_description`)})),data.playbook[a].playbookitem.forEach(a=>{a.name=getTranslation(a.name),a.description&&(a.description=getTranslationByKey(a.description)||""),a.boxes_chosen="1"})});const playbookAbilityMap=new Map([...Object.values(data.playbook).map(a=>a.ability).reduce((b,a)=>(a.forEach(c=>b.add(c)),b),new Set)].map(a=>[a.name.toLowerCase(),a.description])),mySetAttrs=(a,b,c)=>{const d=Object.keys(a).reduce((b,c)=>(b[c]=`${a[c]}`,b),{});setAttrs(d,b,c)},setAttr=(a,b)=>{getAttrs([a],c=>{const d={};`${b}`!==c[a]&&(d[a]=`${b}`),setAttrs(d)})},fillRepeatingSectionFromData=(a,b,c,d)=>{d=d||(()=>{}),getSectionIDs(`repeating_${a}`,e=>{const f=[...e.map(b=>`repeating_${a}_${b}_name`),...e.map(b=>`repeating_${a}_${b}_autogen`)];getAttrs(f,f=>{c&&(e=e.filter(b=>!f[`repeating_${a}_${b}_autogen`]||(removeRepeatingRow(`repeating_${a}_${b}`),!1)));const g=e.map(b=>f[`repeating_${a}_${b}_name`]),h=[],i=b.filter(a=>!g.includes(a.name)).map(b=>{let d;for(;!d;){let a=generateRowID();h.includes(a)||(d=a,h.push(d))}const e={};return c&&(e[`repeating_${a}_${d}_autogen`]="1"),Object.keys(b).reduce((c,e)=>(c[`repeating_${a}_${d}_${e}`]=b[e],c),e)}).reduce((a,b)=>Object.assign(a,b),{});mySetAttrs(i,{},d)})})},diceMagic=a=>{return 0<a?`dice=${(a=>[...Array(a+1).keys()].slice(1))(a).map(()=>"[[d6]]").join("&#44; ")}`:"zerodice=[[d6]]&#44; [[d6]]"},buildRollFormula=a=>` {{?{@{bonusdice}|${[0,1,2,3,4,5,6,-1,-2,-3].map(b=>`${b},${diceMagic(b+(parseInt(a)||0))}`).join("|")}}}}`,buildNumdiceFormula=()=>` {{?{${getTranslation("numberofdice")}|${[0,1,2,3,4,5,6].map(a=>`${a},${diceMagic(a)}`).join("|")}}}}`,emptyFirstRowIfUnnamed=a=>{getSectionIDs(`repeating_${a}`,b=>{const c=b[0];getAttrs([`repeating_${a}_${c}_name`],b=>{b[`repeating_${a}_${c}_name`]||removeRepeatingRow(`repeating_${a}_${c}`)})})},handleBoxesFill=(a,b)=>{on(`change:${a}1 change:${a}2 change:${a}3 change:${a}4`,a=>{"player"!==a.sourceType||getAttrs([a.sourceAttribute],c=>{const d=a.sourceAttribute.slice(0,-1),e={};if("1"===c[a.sourceAttribute]+"")switch(a.sourceAttribute.slice(-1)){case"4":e[`${d}3`]=1;/* falls through */case"3":e[`${d}2`]=1;/* falls through */case"2":e[`${d}1`]=1;}if("0"===c[a.sourceAttribute]+"")switch(a.sourceAttribute.slice(-1)){case"1":e[`${d}2`]=0;/* falls through */case"2":e[`${d}3`]=0;/* falls through */case"3":b&&(e[`${d}4`]=0);}mySetAttrs(e)})})},calculateResistance=a=>{getAttrs([...data.actions[a],`setting_resbonus_${a}`],b=>{const c=data.actions[a].map(a=>b[a]).reduce((a,b)=>a+("0"==`${b}`?0:1),0);setAttr(a,c),setAttr(`${a}_formula`,buildRollFormula(c+parseInt(b[`setting_resbonus_${a}`])))})},calculateVice=()=>{getAttrs(Object.keys(data.actions),a=>{const b=Math.min(...Object.keys(a).map(b=>parseInt(a[b])||0));setAttr("vice_formula",buildRollFormula(b))})},calculateStashFormula=()=>getAttrs(["stash"],a=>{setAttr("stash_formula",buildRollFormula(Math.floor(parseInt(a.stash)/10)))}),calculateWantedFormula=()=>getAttrs(["wanted"],a=>{setAttr("wanted_formula",buildRollFormula(a.wanted))}),calculateCohortDice=a=>{const b=["crew_tier",...a.map(a=>`${a}_impaired`),...a.map(a=>`${a}_type`),...a.map(a=>`${a}_roll_formula`)];getAttrs(b,b=>{const c={};a.forEach(a=>{const d=(parseInt(b.crew_tier)||0)-(parseInt(b[`${a}_impaired`])||0)+("elite"===b[`${a}_type`]||"expert"===b[`${a}_type`]?1:0),e=buildRollFormula(d);e!==b[`${a}_roll_formula`]&&(c[`${a}_roll_formula`]=e)}),setAttrs(c)})},playbookAttributes=[...new Set([].concat(...Object.keys(data.playbook).map(a=>Object.keys(data.playbook[a].base))))],watchedAttributes=new Set(playbookAttributes),actionsFlat=[].concat(...Object.keys(data.actions).map(a=>data.actions[a])),autoExpandFields=["repeating_ability:name","repeating_ability:description","xp_condition","xp_condition_extra","xp_condition2","xp_condition3","crew_xp_condition","heritage","background"],autogenSections=["ability","crewability","friend","contact","playbookitem","upgrade"],translatedNames=[...Object.keys(data.playbook)].reduce((a,b)=>(getTranslationByKey(b)?a[getTranslationByKey(b).toLowerCase()]=b:a[b.toLowerCase()]=b,a),{});/* Utility functions - shouldn't need to touch most of these *//* CONSTANTS *//* EVENT HANDLERS *//* Set default fields when setting crew type or playbook */on("change:playbook",a=>{getAttrs(["playbook","changed_attributes","setting_autofill",...watchedAttributes],b=>{const c=(b.changed_attributes||"").split(","),d=translatedNames[("crew_type"===a.sourceAttribute?b.crew_type:b.playbook).toLowerCase()],e=(a,d)=>{if(data){const e=d.filter(a=>!c.includes(a))// do not reset attributes which have been changed by the user
.filter(a=>b[a]!==(data.defaultValues[a]||""))// do not set attributes if current value is equal to sheet defaults
.reduce((a,b)=>(a[b]=data.defaultValues[b]||"",a),{});Object.keys(a).filter(a=>!c.includes(a)).forEach(b=>e[b]=a[b]),mySetAttrs(e)}};("crew_type"===a.sourceAttribute?b.crew_type:b.playbook)&&setAttr("show_playbook_reminder","0");"1"!==b.setting_autofill||("crew_type"===a.sourceAttribute&&d in data.crew&&(fillRepeatingSectionFromData("contact",data.crew[d].contact,!0),fillRepeatingSectionFromData("crewability",data.crew[d].crewability,!0),fillRepeatingSectionFromData("upgrade",data.crew[d].upgrade,!0),e(data.crew[d].base,crewAttributes)),"playbook"===a.sourceAttribute&&d in data.playbook&&(fillRepeatingSectionFromData("friend",data.playbook[d].friend,!0),fillRepeatingSectionFromData("ability",data.playbook[d].ability,!0),fillRepeatingSectionFromData("playbookitem",data.playbook[d].playbookitem,!0),e(data.playbook[d].base,playbookAttributes)))})});const fillPlaybookAbility=()=>{const a="repeating_ability";getAttrs([`${"repeating_ability"}_name`,`${"repeating_ability"}_description`],b=>{if(!b[`${a}_description`]){const c=playbookAbilityMap.get((b[`${a}_name`]||"").toLowerCase());c&&setAttr(`${a}_description`,c)}})},fillCrewAbility=()=>{const a="repeating_crewability";getAttrs([`${"repeating_crewability"}_name`,`${"repeating_crewability"}_description`],b=>{if(!b[`${a}_description`]){const c=crewAbilityMap.get((b[`${a}_name`]||"").toLowerCase());c&&setAttr(`${a}_description`,c)}})};/* Watch repeating rows for changes and set autogen to false if change happens *//* Watch for changes in auto-set attributes and update changed_attributes*//* Register attribute/action event handlers *//* Calculate stash *//* Calculate trauma *//* Generate buttons *//* Calculate cohort quality *//* Set correct verb for cohort roll button *//* Left-fill checkboxes *///handleBoxesFill("upgrade_24_check_", true);
// This is smart
// --- // ["item", "playbookitem", "upgrade"].forEach(sName => handleBoxesFill(`repeating_${sName}:check_`));
/* Pseudo-radios: TODO use this for labels *//* Default values for number of upgrades boxes — probably not necessary anymore */// on('change:repeating_upgrade:boxes_chosen', () => {
// 	getAttrs(['repeating_upgrade_numboxes'], v => {
// 		if (!['1', '2', '3'].includes(v.repeating_upgrade_numboxes)) {
// 			setAttr('repeating_upgrade_numboxes', '1');
// 		}
// 	});
// });
/* Resistance query *//* Trim whitespace in auto-expand fields *//* Clean chat image URL *//* Number of dice prompt *//* Probably don't need this...
on("sheet:opened", () => {
	/* Set up translated attributes *//*
	const translatedAttrs = {
		bonusdice: getTranslation("bonusdice"),
		effect_query: getTranslation("effect_query"),
		notes_query: `?{${getTranslation("notes")}}`,
		numberofdice: buildNumdiceFormula(),
		position_query: `?{${getTranslation("position")}|` +
			`${getTranslation("risky")},position=${getTranslation("risky")}|` +
			`${getTranslation("controlled")},position=${getTranslation("controlled")}|` +
			`${getTranslation("desperate")},position=${getTranslation("desperate")}|` +
			`${getTranslation("fortune_roll")},position=}`,
	};
	getAttrs(Object.keys(translatedAttrs), v => {
		const setting = {};
		Object.keys(translatedAttrs).forEach(name => {
			if (v[name] !== translatedAttrs[name]) setting[name] = translatedAttrs[name];
		});
		mySetAttrs(setting);
	});
});
*//* INITIALISATION AND UPGRADES */on("change:repeating_ability:name",fillPlaybookAbility),on("change:repeating_crewability:name",fillCrewAbility),autogenSections.forEach(a=>{on(`change:repeating_${a}`,b=>{getAttrs([`repeating_${a}_autogen`],c=>{c[`repeating_${a}_autogen`]&&"player"===b.sourceType&&setAttr(`repeating_${a}_autogen`,"")})})}),watchedAttributes.forEach(a=>{on(`change:${a}`,b=>{"player"===b.sourceType&&getAttrs(["changed_attributes"],b=>{const c=[...new Set(b.changed_attributes.split(",")).add(a)].filter(a=>!!a).join(",");setAttr("changed_attributes",c)})})}),Object.keys(data.actions).forEach(a=>{on([...data.actions[a],`setting_resbonus_${a}`].map(a=>`change:${a}`).join(" "),()=>calculateResistance(a)),on(`change:${a}`,calculateVice)}),on("change:stash",calculateStashFormula),on("change:wanted",calculateWantedFormula),on(data.traumas.map(a=>`change:trauma_${a}`).join(" "),a=>{getAttrs(data.traumas.map(a=>`trauma_${a}`),b=>{if("player"===a.sourceType){const a=data.traumas.reduce((a,c)=>a+(parseInt(b[`trauma_${c}`])||0),0);setAttr("trauma",a)}})}),on("change:generate_factions",()=>{setAttr("show_faction_generatebutton","0"),Object.keys(data.factions).forEach(a=>{fillRepeatingSectionFromData(a,data.factions[a])})}),autogenSections.forEach(a=>{on(`change:generate_${a}`,()=>{getAttrs(["generate_source_character","generate_source_crew","sheet_type"],b=>{const c="character"===b.sheet_type?data.playbook:data.crew,d=b[`generate_source_${b.sheet_type}`];d in c&&(emptyFirstRowIfUnnamed(a),fillRepeatingSectionFromData(a,c[d][a]))})})}),on(["crew_tier","cohort1_impaired","cohort1_type"].map(a=>`change:${a}`).join(" "),()=>calculateCohortDice(["cohort1"])),on("change:repeating_cohort",()=>calculateCohortDice(["repeating_cohort"])),on("change:crew_tier",()=>{getSectionIDs("repeating_cohort",b=>calculateCohortDice(b.map(a=>`repeating_cohort_${a}`)))}),on("change:char_cohort_quality change:char_cohort_impaired change:setting_show_cohort",()=>{getAttrs(["char_cohort_quality","char_cohort_impaired"],a=>{const b=(parseInt(a.char_cohort_quality)||0)-(parseInt(a.char_cohort_impaired)||0);setAttr("char_cohort_roll_formula",buildRollFormula(b))})}),["char_cohort","cohort1","repeating_cohort"].forEach(a=>{const b="change:"+("repeating_cohort"===a?`${a}:type`:`${a}_type`);on(b,b=>{const c="expert"===b.newValue?"^{rolls_their}":"^{roll_their}";setAttr(`${a}_verb`,c)})}),["crew_tier",...actionsFlat].forEach(a=>{on(`change:${a}`,b=>{"0"===b.newValue+""&&"player"===b.sourceType&&setAttr(a,(parseInt(b.previousValue)||1)-1),setAttr(`${a}_formula`,buildRollFormula(b.newValue||"0"))})}),on("change:setting_consequence_query sheet:opened",()=>{getAttrs(["setting_consequence_query"],a=>{const b="1"===a.setting_consequence_query+""?`?{${getTranslation("consequence")}|${getTranslation("a_consequence")}}`:"^{a_consequence}";setAttr("consequence_query",b)})}),autoExpandFields.forEach(a=>{on(`change:${a}`,b=>{const c=a.replace(":","_");getAttrs([c],a=>{a[c].trim()!==a[c]&&"player"===b.sourceType&&setAttr(c,a[c].trim())})})}),on("change:chat_image",a=>{const b=(a.newValue||"").match(/^(https:\/\/s3\.amazonaws\.com\/files\.d20\.io\/images\/.*\.jpg)\?\d+$/);b&&setAttr("chat_image",b[1])}),on("sheet:opened",()=>{/* Setup and upgrades */getAttrs(["sheet_type","changed_attributes","playbook"],a=>{["villain","story"].includes(a.sheet_type)||setAttr("sheet_type","hero"),(a.playbook||a.crew_type)&&setAttr("show_playbook_reminder","0")}),getAttrs(["version"],a=>{// Set version number
a.version?(a=>{// const [major, minor] = version && version.split(".").map(x => parseInt(x));
console.log(`Found version ${a}.`)})(a.version):(()=>{const a=["ability","friend","crewability","contact","playbookitem","upgrade","framefeature"].reduce((a,b)=>(a[`repeating_${b}_${generateRowID()}_autogen`]=1,a),{});/* Set translated default values */mySetAttrs(a),getAttrs(Object.keys(data.translatedDefaults),a=>{const b={};Object.keys(data.translatedDefaults).forEach(c=>{a[c]!==data.translatedDefaults[c]&&(b[c]=data.translatedDefaults[c])}),mySetAttrs(b)}),console.log("Initialising new sheet.")})(),mySetAttrs({version:sheetVersion,character_sheet:`${sheetName} v${sheetVersion}`})})});</script>
